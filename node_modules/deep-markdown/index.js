var deep = require("deep/deep");
var fs = require("fs");
var marked = require("marked");
var pygmentize = require("pygmentize-bundled");
require("deep-node-fs/html");
//__________________________________________________

var markedOpt = {
  gfm: true,
  highlight: function (code, lang, callback) {
  	//console.log("highlight : ", lang)
    pygmentize({ lang: lang, format: 'html' }, code, function (err, result) {
    	//console.log("pygmentised : ", result.toString())
      	if (err) 
      		return callback(err);
      	callback(null, result.toString());
    });
  },
  tables: true,
  breaks: false,
  pedantic: false,
  sanitize: true,
  smartLists: true,
  smartypants: false,
  langPrefix: 'lang-'
};

var Store = deep.compose.Classes(deep.store.node.fs.HTML,
{
	cachePath:"markdown::",
	responseParser:function(datas){
		if(datas instanceof Buffer)
			datas = datas.toString("utf8");
		var def = deep.Deferred();
		marked(datas, markedOpt, function (err, content) {
			if (err)
				return def.reject(err);
			def.resolve(content);
		});
		return def.promise();
	},
});
deep.protocoles.marked = new Store("markdown", deep.globals.rootPath, null, { watch:true});

return deep.protocoles.marked;